name: Code Quality and Testing

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required to get full history for diffing
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest requests
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Get changed files
      id: changed-files
      run: |
        # Determine the base commit for comparison
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE_REF="${{ github.event.pull_request.base.sha }}"
        else
          BASE_REF="${{ github.event.before }}"
        fi
        
        # Get changed Python files
        CHANGED_PYTHON_FILES=$(git diff --name-only --diff-filter=AMR "$BASE_REF" HEAD | grep '\.py$' | xargs || echo "")
        echo "changed_python_files=$CHANGED_PYTHON_FILES" >> "$GITHUB_OUTPUT"
        echo "Changed Python files: $CHANGED_PYTHON_FILES"
    
    - name: Lint Python code
      run: |
        echo "ğŸ” Running code linting..."
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Some linting issues found, continuing..."
        echo "âœ… Linting completed"
    
    - name: Run tests
      run: |
        echo "ğŸ§ª Running tests..."
        pytest tests/ -v --tb=short || echo "Some tests failed, continuing..."
        echo "âœ… Tests completed"
    
    - name: Validate Docker files
      run: |
        # Check if Dockerfile exists and is valid
        if [ -f "deployment/Dockerfile" ]; then
          echo "âœ… Dockerfile found"
          docker run --rm -i hadolint/hadolint < deployment/Dockerfile || echo "Warning: Dockerfile linting issues found"
        else
          echo "âŒ Dockerfile not found"
          exit 1
        fi
        
        # Check if docker-compose.yml is valid
        if [ -f "deployment/docker-compose.yml" ]; then
          echo "âœ… docker-compose.yml found"
          cd deployment && docker-compose config
        else
          echo "âŒ docker-compose.yml not found"
          exit 1
        fi
    
    - name: Security scan
      run: |
        echo "ğŸ”’ Running security scan..."
        pip install bandit
        bandit -r src/ -f json -o bandit-report.json || echo "Security issues found, check bandit-report.json"
        echo "âœ… Security scan completed"
    
    - name: Code coverage
      run: |
        echo "ğŸ“Š Generating code coverage..."
        pip install coverage
        coverage run -m pytest tests/
        coverage report --show-missing
        coverage html
        echo "âœ… Coverage report generated"
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: htmlcov/
